<?php
/**
 * @file
 * contextual_range_filter.module
 *
 * Adds to Views an option to contextually filter by range.
 * For instance, if you have a View with a float field (eg Price or Distance)
 * and have added this field as the first contextual filter, then you can filter
 * your View page like so:
 *
 *   http://mysite.com/myview/100--199.99
 *
 * Integers, floats and string types are supported.
 * The OR ('+') operators is supported.
 * The negate operator ("Exclude" tick box) is supported.
 * "Glossary mode" (match on first N characters) is supported.
 */

define('CONTEXTUAL_RANGE_FILTER_SEPARATOR1', '--'); // same as used for dates
define('CONTEXTUAL_RANGE_FILTER_SEPARATOR2', ':');  // alternative delimiter

/**
 * Split a filter range string into an array containing "from" and "to" values.
 *
 * @param string $range, format "from--to", "from--" or "--to".
 *   A single value is also allowed. A single colon is accepted instead of --
 *
 * @return array of length 2, the 2nd value equals FALSE when no separator was found
 */
function contextual_range_filter_split($range) {
  if (is_array($range)) { // defensive programming to make sure we have a string
    $range = reset($range);
  }
  $range = trim($range);
  $from_to = explode(CONTEXTUAL_RANGE_FILTER_SEPARATOR1, $range);
  if (count($from_to) < 2) {
    $from_to = explode(CONTEXTUAL_RANGE_FILTER_SEPARATOR2, $range);
  }
  return count($from_to) == 1 ? array(reset($from_to), FALSE) : $from_to;
}

/**
 * Implements hook_menu().
 */
function contextual_range_filter_menu() {
  $items['admin/config/content/contextual_range_filter'] = array(
    'title' => 'Contextual Range Filters',
    'description' => 'Select which contextual filters need to be converted to contextual <em>range</em> filters.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('contextual_range_filter_admin_config'),
    'access arguments' => array('administer contextual range filters'),
    'file' => 'contextual_range_filter.admin.inc'
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function contextual_range_filter_permission() {
  return array(
    'administer contextual range filters' => array(
      'title' => t('Administer contextual range filters'),
      'description' => t('Access the Contextual Range Filter configuration page.'),
    )
  );
}

/**
 * Implements hook_views_api().
 */
function contextual_range_filter_views_api() {
  return array(
    'api'  => views_api_version(),
    'path' => drupal_get_path('module', 'contextual_range_filter') . '/views',
  );
}
